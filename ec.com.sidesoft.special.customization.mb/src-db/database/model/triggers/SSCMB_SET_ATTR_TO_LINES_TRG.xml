<?xml version="1.0"?>
  <database name="TRIGGER SSCMB_SET_ATTR_TO_LINES_TRG">
    <trigger name="SSCMB_SET_ATTR_TO_LINES_TRG" table="M_INOUT" fires="before" insert="false" update="true" delete="false" foreach="row">
      <body><![CDATA[  v_documentno	VARCHAR2(32);      
  v_description	VARCHAR2(300);      
  v_docbasetype	    VARCHAR2(60);      
  v_isreturn	    VARCHAR2(1);      
  v_issotrx	    VARCHAR2(1);      
  
  cur_lines 	RECORD;
BEGIN
   
  IF AD_isTriggerEnabled()='N' THEN RETURN;
  END IF; 

  IF (UPDATING) THEN


  SELECT mi.issotrx, dt.docbasetype, dt.isreturn
INTO v_issotrx,v_docbasetype, v_isreturn  FROM m_inout mi  
LEFT JOIN c_doctype dt ON mi.c_doctype_id = dt.c_doctype_id
WHERE mi.m_inout_id= :new.m_inout_id;

--PARÁMETROS QUE DETERMINAN ALBARÁN (PROVEEDOR).
IF (v_issotrx='N' AND v_docbasetype ='MMR' AND v_isreturn ='N' )THEN


  IF (:old.documentno <> :new.documentno) THEN

  FOR cur_lines IN (SELECT * FROM m_inoutline WHERE m_inout_id = :new.m_inout_id ) 
  LOOP
	IF ((SELECT m_attributeset_id FROM m_product WHERE m_product_id = cur_lines.m_product_id) IS NOT NULL )THEN

		IF (cur_lines.m_attributesetinstance_id  IS  NULL) THEN
		 RAISE_APPLICATION_ERROR(-20000,'Valor de atributos no definidos para la línea '||cur_lines.line ||'.');
		END IF;

		IF ((SELECT em_sscmb_concat_documentno FROM m_product mp
		INNER JOIN m_attributeset ab ON  mp.m_attributeset_id =ab.m_attributeset_id WHERE mp.m_product_id = cur_lines.m_product_id) ='Y')THEN

		IF( (SELECT count(*) FROM m_attributesetinstance WHERE m_attributesetinstance_id = cur_lines.m_attributesetinstance_id AND description LIKE '%'||:old.documentno||'%' ) >0) THEN
					
		SELECT description into v_description FROM m_attributesetinstance WHERE m_attributesetinstance_id = cur_lines.m_attributesetinstance_id;
		UPDATE m_attributesetinstance SET description= REPLACE(v_description,:old.documentno,:new.documentno) WHERE m_attributesetinstance_id = cur_lines.m_attributesetinstance_id;
		
		END IF;

		END IF;
		
	END IF;
  END LOOP;
  END IF;
  END IF;
    END IF;
  END SSCMB_SET_ATTR_TO_LINES_TRG
]]></body>
    </trigger>
  </database>
