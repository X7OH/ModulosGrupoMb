<?xml version="1.0"?>
  <database name="FUNCTION SINW_VALIDATE_WEIGHT_EXIST">
    <function name="SINW_VALIDATE_WEIGHT_EXIST" type="NULL">
      <parameter name="p_ep_instance" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_ResultStr 	    VARCHAR2(2000):='';
p_record_id         VARCHAR2(60);      
v_linecounter       NUMBER(32);       --OBTG:VARCHAR2--
v_product_name	    VARCHAR2(60);      
v_docbasetype	    VARCHAR2(60);      
v_isreturn	    VARCHAR2(1);      
v_issotrx	    VARCHAR2(1);      

TYPE RECORD IS REF CURSOR;
cur_params          RECORD;
cur_lines           RECORD;

BEGIN

  FOR cur_params IN (
    SELECT *
    FROM ad_ep_instance_para
    WHERE ad_ep_instance_id = p_ep_instance
    ) LOOP
    IF (cur_params.parametername LIKE 'Record_ID') THEN
      p_record_id := cur_params.p_string;
    END IF;
  END LOOP;
  
  SELECT mi.issotrx, dt.docbasetype, dt.isreturn
INTO v_issotrx,v_docbasetype, v_isreturn  FROM m_inout mi  
LEFT JOIN c_doctype dt ON mi.c_doctype_id = dt.c_doctype_id
WHERE mi.m_inout_id= p_record_id;

--PARÁMETROS QUE DETERMINAN ALBARÁN (PROVEEDOR).
IF (v_issotrx='N' AND v_docbasetype ='MMR' AND v_isreturn ='N' )THEN
  FOR cur_lines IN (
    SELECT *
    FROM m_inoutline
    WHERE m_inout_id = p_record_id
    ) LOOP	

	IF((SELECT em_sinw_weight_record FROM m_product WHERE m_product_id=cur_lines.m_product_id)='Y') THEN
	  SELECT coalesce(count(*),0) INTO v_linecounter FROM sinw_weight sw WHERE sw.m_inoutline_id  = cur_lines.m_inoutline_id;

	  IF(v_linecounter=0) THEN
		  SELECT mp.name INTO v_product_name FROM m_product mp where mp.m_product_id= cur_lines.m_product_id;
			RAISE_APPLICATION_ERROR(-20000, 'La línea '||cur_lines.line||' producto '||v_product_name||' no tiene registros en la solapa Pesos.');
	  END IF;
	END IF;
	
END LOOP;
END IF;
EXCEPTION
WHEN OTHERS THEN
  DBMS_OUTPUT.PUT_LINE( v_ResultStr);
  RAISE;
END SINW_VALIDATE_WEIGHT_EXIST
]]></body>
    </function>
  </database>
