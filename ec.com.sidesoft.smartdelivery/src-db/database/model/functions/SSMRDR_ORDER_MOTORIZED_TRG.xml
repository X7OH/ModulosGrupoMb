<?xml version="1.0"?>
  <database name="FUNCTION SSMRDR_ORDER_MOTORIZED_TRG">
    <function name="SSMRDR_ORDER_MOTORIZED_TRG" type="VARCHAR">
      <body><![CDATA[v_bpname VARCHAR2(100):='';
v_bpvalue VARCHAR2(100):='';

BEGIN

  IF AD_isTriggerEnabled()='N' THEN IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
  END IF;

    IF (TG_OP = 'UPDATE') THEN

        IF( old.processed='Y' AND old.issotrx='Y' AND (old.EM_Sscmb_Sales_Origin = 'CLC' OR old.EM_Sscmb_Sales_Origin = 'WEB' ) AND old.em_ssmrdr_motorized_id is null) THEN

            IF(new.em_obpos_app_cashup_id is NOT NULL) THEN 

                SELECT name, c_bpartner_id INTO v_bpname, v_bpvalue FROM c_bpartner WHERE c_bpartner_id = new.em_ssmrdr_motorized_id;

                UPDATE c_order 
                SET em_saqb_deliverystatus = 'DOT', em_ssmrdr_processed_date = now(), em_saqb_allocation_hour = to_char(now(), 'HH24:MI:SS'),
                EM_Ssmrdr_Motorizedname = v_bpname, EM_Saqb_Assigned_Motorized = v_bpvalue  
                WHERE c_order_id = new.c_order_id;
                
            END IF;

        END IF;

    END IF;

  IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END SSMRDR_ORDER_MOTORIZED_TRG
]]></body>
    </function>
  </database>
