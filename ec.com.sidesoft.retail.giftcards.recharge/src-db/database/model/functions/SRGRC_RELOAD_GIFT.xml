<?xml version="1.0"?>
  <database name="FUNCTION SRGRC_RELOAD_GIFT">
    <function name="SRGRC_RELOAD_GIFT" type="NULL">
      <parameter name="p_pinstance_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[p_message           VARCHAR2(2000);    
p_record_id         VARCHAR2(60);      
p_docaction         VARCHAR2(60);      
p_user              VARCHAR2(60);      
p_result            NUMBER;
p_docstatus         VARCHAR2(60);
p_issotrx           VARCHAR2(60);
v_ResultStr         VARCHAR2(2000):='';


-- Nuevos parametros
p_amount            NUMBER;
v_Iscancelled 	    CHAR(1);
v_Message 	    VARCHAR2(2000);    

TYPE RECORD IS REF CURSOR;
Cur_Params          RECORD;
cur_lines           RECORD;

  BEGIN
    --  Update AD_PInstance
    DBMS_OUTPUT.PUT_LINE('Updating PInstance - Processing ' || p_PInstance_ID) ;
    v_ResultStr:='PInstanceNotFound';
    AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'Y', NULL, NULL) ;
   BEGIN --BODY
   
  FOR Cur_Params IN (
    SELECT i.Record_ID,
       i.ad_client_id, 
          i.ad_org_id,
        p.ParameterName,
        p.P_String,
        p.P_Number,
        p.P_Date
      FROM AD_PInstance i
      LEFT JOIN AD_PInstance_Para p
        ON i.AD_PInstance_ID=p.AD_PInstance_ID
      WHERE i.AD_PInstance_ID=p_PInstance_ID
      ORDER BY p.SeqNo
    ) LOOP
	    IF (Cur_Params.ParameterName = 'AMOUNT') THEN
	      p_amount := Cur_Params.p_number;
	    END IF;

	    p_record_id:=Cur_Params.Record_ID;
  END LOOP;


	SELECT COALESCE((select iscancelled
	from gcnv_giftcard_inst where gcnv_giftcard_inst_id =  p_record_id
	),'N')
	INTO 	v_Iscancelled
	FROM DUAL;

	IF (COALESCE(p_record_id,'ND') <>'ND' AND v_Iscancelled='Y') THEN
	    v_Message:='@Srgrc_GiftCardCancel@';
	    AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_Message) ;
	    RETURN;
	ELSE

		IF (COALESCE(p_amount,0)=0) THEN
			    v_Message:='@Srgrc_ErrorAmountGiftCard@';
			    AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_Message) ;
			    RETURN;
		ELSE
			UPDATE gcnv_giftcard_inst 
			SET CURRENTAMOUNT = CURRENTAMOUNT + p_amount
			WHERE gcnv_giftcard_inst_id =  p_record_id; 
		END IF; 	


		
	END IF;

	


    v_Message:='@Success@';
   --  Update AD_PInstance
    DBMS_OUTPUT.PUT_LINE('Updating PInstance - Finished ' || v_Message) ;
    AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 1, v_Message) ;
    RETURN;
    
  END; --BODY
EXCEPTION
WHEN OTHERS THEN
  v_ResultStr:= '@ERROR=' || SQLERRM;
  DBMS_OUTPUT.PUT_LINE(v_ResultStr) ;
   ROLLBACK;
  AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_ResultStr) ;
  RETURN;
END SRGRC_RELOAD_GIFT
]]></body>
    </function>
  </database>
