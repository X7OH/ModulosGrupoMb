<?xml version="1.0"?>
  <database name="TRIGGER SDELVR_MAIN_FAMILY_UNIQUE_TRG">
    <trigger name="SDELVR_MAIN_FAMILY_UNIQUE_TRG" table="OBCOMBO_FAMILY" fires="before" insert="true" update="true" delete="false" foreach="row">
      <body><![CDATA[
v_count NUMBER:=0;

BEGIN

    IF AD_isTriggerEnabled()='N' THEN RETURN;
    END IF;

    SELECT count(*) 
    INTO v_count 
    FROM obcombo_family cf 
    WHERE cf.m_offer_id = :new.m_offer_id 
    AND cf.em_sdelvr_deliprice='Y' 
    AND cf.obcombo_family_id NOT IN(:new.obcombo_family_id) ;

    IF(INSERTING) THEN
	    IF (v_count>0) THEN
	      IF(:new.em_sdelvr_deliprice <> 'N') THEN
		      RAISE_APPLICATION_ERROR(-20000, '@Sdelvr_Only_One_Main_Family@');
	      END IF;    
	    END IF;	
    END IF;
    	
    IF(UPDATING) THEN
	    IF (v_count>0) THEN
	      IF(:new.em_sdelvr_deliprice <> :old.em_sdelvr_deliprice) THEN
		      RAISE_APPLICATION_ERROR(-20000, '@Sdelvr_Only_One_Main_Family@');
	      END IF;    
	    END IF;
    END IF;       

END SDELVR_MAIN_FAMILY_UNIQUE_TRG
]]></body>
    </trigger>
  </database>
