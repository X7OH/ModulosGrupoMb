<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="ReportDetailedSalesCost" pageWidth="950" pageHeight="595" orientation="Landscape" columnWidth="910" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="Org" class="java.lang.String"/>
	<parameter name="DateFrom" class="java.util.Date"/>
	<parameter name="DateTo" class="java.util.Date"/>
	<parameter name="Category" class="java.lang.String"/>
	<queryString>
		<![CDATA[SELECT G.NAME AS ORGANIZACION, a.documentno AS NUMERO_GUIA, a.movementdate AS FECHA_GUIA, C.VALUE AS COD_CLIENTE,
C.NAME AS NOM_CLIENTE, D.VALUE AS COD_PRODUCTO, E.NAME AS CATEGORIA,
REPLACE(D.NAME, '"', '') AS NOM_PROPRODUCT,
B.movementqty AS CANTIDAD,
(CASE
	WHEN B.movementqty >=0 THEN (trxcost.cost)
	ELSE (trxcost.cost)*-1
END) AS COSTO,
(FAC.AMTACCTDR - FAC.AMTACCTCR) as COST_CONTABLE
FROM M_INOUT A
LEFT JOIN M_INOUTLINE B ON A.M_INOUT_ID = B.M_INOUT_ID
INNER JOIN AD_ORG G ON A.AD_ORG_ID = G.AD_ORG_ID
INNER JOIN C_BPARTNER C ON A.C_BPARTNER_ID = C.C_BPARTNER_ID
INNER JOIN M_PRODUCT D ON B.M_PRODUCT_ID = D.M_PRODUCT_ID
INNER JOIN M_PRODUCT_CATEGORY E ON D.M_PRODUCT_CATEGORY_ID = E.M_PRODUCT_CATEGORY_ID
left join m_transaction trx ON trx.m_inoutline_id = B.m_inoutline_id
left join (SELECT SUM(cost) as cost, m_transaction_id, c_currency_id
	   FROM m_transaction_cost
	   GROUP BY m_transaction_id, c_currency_id
	  ) trxcost ON trx.m_transaction_id = trxcost.m_transaction_id
LEFT JOIN FACT_ACCT FAC ON A.M_INOUT_ID = FAC.RECORD_ID AND B.M_INOUTLINE_ID = FAC.LINE_ID
WHERE A.MOVEMENTDATE BETWEEN $P{DateFrom} AND $P{DateTo} AND ($P{Org} IS NULL OR G.AD_ORG_ID=$P{Org}) AND ($P{Category} IS NULL OR E.M_PRODUCT_CATEGORY_ID=$P{Category})
AND A.DOCSTATUS IN ('CO', 'VO')
AND A.ISSOTRX = 'Y'
AND FAC.ACCOUNT_ID in (SELECT ACCOUNT_ID FROM C_VALIDCOMBINATION
WHERE C_VALIDCOMBINATION_ID IN (SELECT DISTINCT P_COGS_ACCT FROM M_PRODUCT_ACCT))
AND FAC.DATEACCT BETWEEN $P{DateFrom} AND $P{DateTo}
ORDER BY FECHA_GUIA, NUMERO_GUIA]]>
	</queryString>
	<field name="organizacion" class="java.lang.String"/>
	<field name="numero_guia" class="java.lang.String"/>
	<field name="fecha_guia" class="java.sql.Timestamp"/>
	<field name="cod_cliente" class="java.lang.String"/>
	<field name="nom_cliente" class="java.lang.String"/>
	<field name="cod_producto" class="java.lang.String"/>
	<field name="categoria" class="java.lang.String"/>
	<field name="nom_proproduct" class="java.lang.String"/>
	<field name="cantidad" class="java.math.BigDecimal"/>
	<field name="costo" class="java.math.BigDecimal"/>
	<field name="cost_contable" class="java.math.BigDecimal"/>
	<variable name="costo_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{costo}]]></variableExpression>
	</variable>
	<variable name="cost_contable_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{cost_contable}]]></variableExpression>
	</variable>
	<variable name="costo_2" class="java.math.BigDecimal" resetType="Page" calculation="Sum">
		<variableExpression><![CDATA[$F{costo}]]></variableExpression>
	</variable>
	<variable name="cost_contable_2" class="java.math.BigDecimal" resetType="Page" calculation="Sum">
		<variableExpression><![CDATA[$F{cost_contable}]]></variableExpression>
	</variable>
	<variable name="costo_3" class="java.math.BigDecimal" resetType="Group" resetGroup="organizacion" calculation="Sum">
		<variableExpression><![CDATA[$F{costo}]]></variableExpression>
	</variable>
	<variable name="cost_contable_3" class="java.math.BigDecimal" resetType="Group" resetGroup="organizacion" calculation="Sum">
		<variableExpression><![CDATA[$F{cost_contable}]]></variableExpression>
	</variable>
	<group name="organizacion">
		<groupExpression><![CDATA[$F{organizacion}]]></groupExpression>
		<groupHeader>
			<band height="50">
				<textField>
					<reportElement x="67" y="10" width="204" height="20"/>
					<textElement>
						<font fontName="Arial" isBold="true"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{organizacion}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="119" y="30" width="81" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Cod Cliente]]></text>
				</staticText>
				<staticText>
					<reportElement x="373" y="30" width="100" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Categoria Producto]]></text>
				</staticText>
				<staticText>
					<reportElement x="0" y="30" width="67" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Número Guía]]></text>
				</staticText>
				<staticText>
					<reportElement x="67" y="30" width="52" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Fecha Guía]]></text>
				</staticText>
				<staticText>
					<reportElement x="200" y="30" width="173" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Nombre Cliente]]></text>
				</staticText>
				<staticText>
					<reportElement x="473" y="30" width="70" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Cod Producto]]></text>
				</staticText>
				<staticText>
					<reportElement x="543" y="30" width="186" height="20"/>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Nombre Producto]]></text>
				</staticText>
				<staticText>
					<reportElement x="790" y="30" width="61" height="20"/>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Costo Guia]]></text>
				</staticText>
				<staticText>
					<reportElement x="729" y="30" width="61" height="20"/>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Cantidad ]]></text>
				</staticText>
				<staticText>
					<reportElement x="851" y="30" width="59" height="20"/>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Arial" size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Costo Contabilidad]]></text>
				</staticText>
				<staticText>
					<reportElement x="0" y="10" width="67" height="20"/>
					<textElement>
						<font fontName="Arial" isBold="true"/>
					</textElement>
					<text><![CDATA[Organización:]]></text>
				</staticText>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="23">
				<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
					<reportElement x="789" y="0" width="62" height="20"/>
					<textElement textAlignment="Right">
						<font fontName="Arial" isBold="true"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{costo_3}]]></textFieldExpression>
				</textField>
				<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
					<reportElement x="851" y="0" width="58" height="20"/>
					<textElement textAlignment="Right">
						<font fontName="Arial" isBold="true"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{cost_contable_3}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="543" y="0" width="186" height="20"/>
					<textElement textAlignment="Right">
						<font fontName="Arial" isBold="true"/>
					</textElement>
					<text><![CDATA[Total Organización:]]></text>
				</staticText>
			</band>
		</groupFooter>
	</group>
	<title>
		<band height="69" splitType="Stretch">
			<staticText>
				<reportElement x="143" y="0" width="570" height="20"/>
				<textElement textAlignment="Center">
					<font fontName="Arial" size="14" isBold="true"/>
				</textElement>
				<text><![CDATA[Reporte de Costo de Ventas - Detallado]]></text>
			</staticText>
			<staticText>
				<reportElement x="313" y="33" width="67" height="20"/>
				<textElement>
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Fecha Desde:]]></text>
			</staticText>
			<staticText>
				<reportElement x="438" y="33" width="39" height="20"/>
				<textElement>
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[ Hasta:]]></text>
			</staticText>
			<textField pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement x="382" y="33" width="54" height="20"/>
				<textElement>
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[$P{DateFrom}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement x="479" y="33" width="100" height="20"/>
				<textElement>
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[$P{DateTo}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<detail>
		<band height="20" splitType="Stretch">
			<textField>
				<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="67" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{numero_guia}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="67" y="0" width="52" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.sql.Timestamp"><![CDATA[$F{fecha_guia}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement stretchType="RelativeToBandHeight" x="119" y="0" width="81" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{cod_cliente}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement stretchType="RelativeToBandHeight" x="200" y="0" width="173" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nom_cliente}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement positionType="Float" stretchType="RelativeToBandHeight" x="373" y="0" width="100" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{categoria}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement stretchType="RelativeToBandHeight" x="473" y="0" width="70" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{cod_producto}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement stretchType="RelativeToBandHeight" x="543" y="0" width="186" height="20"/>
				<textElement>
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nom_proproduct}]]></textFieldExpression>
			</textField>
			<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="729" y="0" width="60" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{cantidad}]]></textFieldExpression>
			</textField>
			<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="789" y="0" width="62" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{costo}]]></textFieldExpression>
			</textField>
			<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="851" y="0" width="58" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{cost_contable}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<lastPageFooter>
		<band height="20">
			<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
				<reportElement x="789" y="0" width="62" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{costo_1}]]></textFieldExpression>
			</textField>
			<textField pattern="###0.0000;(###0.0000)" isBlankWhenNull="true">
				<reportElement x="851" y="0" width="58" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{cost_contable_1}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="543" y="0" width="186" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Total Costo de Ventas:]]></text>
			</staticText>
		</band>
	</lastPageFooter>
</jasperReport>
